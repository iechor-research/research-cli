name: Build Native Wrapper

on:
  push:
    tags:
      - 'v*-native'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.2.6)'
        required: true
        default: '0.2.6'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: macOS Intel
            os: macos-latest
            target: x86_64-apple-darwin
            binary: research-cli
            archive: research-cli-darwin-x64
          - name: macOS Apple Silicon
            os: macos-latest
            target: aarch64-apple-darwin
            binary: research-cli
            archive: research-cli-darwin-arm64
          - name: Windows x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: research-cli.exe
            archive: research-cli-win32-x64.exe
          - name: Linux x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            binary: research-cli
            archive: research-cli-linux-x64
          - name: Linux ARM64
            os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            binary: research-cli
            archive: research-cli-linux-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install Rust target
        run: rustup target add ${{ matrix.platform.target }}

      - name: Install Linux dependencies
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential musl-tools
          if [[ "${{ matrix.platform.target }}" == "aarch64-unknown-linux-musl" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi

      - name: Configure cross-compilation for Linux ARM64
        if: matrix.platform.target == 'aarch64-unknown-linux-musl'
        run: |
          mkdir -p src-tauri/.cargo
          cat > src-tauri/.cargo/config.toml << 'EOF'
          [target.aarch64-unknown-linux-musl]
          linker = "aarch64-linux-gnu-gcc"
          EOF

      - name: Build binary
        working-directory: src-tauri
        run: cargo build --release --target ${{ matrix.platform.target }}

      - name: Package binary
        shell: bash
        run: |
          mkdir -p dist-native
          if [[ "${{ matrix.platform.os }}" == "windows-latest" ]]; then
            cp "src-tauri/target/${{ matrix.platform.target }}/release/${{ matrix.platform.binary }}" "dist-native/${{ matrix.platform.archive }}"
          else
            cp "src-tauri/target/${{ matrix.platform.target }}/release/${{ matrix.platform.binary }}" "dist-native/${{ matrix.platform.archive }}"
            chmod +x "dist-native/${{ matrix.platform.archive }}"
          fi

      - name: Generate build info
        shell: bash
        run: |
          if [[ "${{ matrix.platform.os }}" == "windows-latest" ]]; then
            BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
            FILE_SIZE=$(powershell -Command "(Get-Item 'dist-native/${{ matrix.platform.archive }}').Length")
            SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc -l 2>/dev/null || echo "N/A")
            SIZE_DISPLAY="${SIZE_MB}MB"
          else
            BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
            SIZE_DISPLAY=$(du -h "dist-native/${{ matrix.platform.archive }}" | cut -f1)
          fi
          
          cat > "dist-native/${{ matrix.platform.archive }}.json" << EOF
          {
            "version": "${{ github.event.inputs.version || '0.2.6' }}",
            "buildTime": "$BUILD_TIME",
            "platform": "${{ matrix.platform.name }}",
            "target": "${{ matrix.platform.target }}",
            "binaryName": "${{ matrix.platform.archive }}",
            "size": "$SIZE_DISPLAY",
            "description": "Native wrapper for Research CLI - ${{ matrix.platform.name }}"
          }
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.archive }}
          path: |
            dist-native/${{ matrix.platform.archive }}
            dist-native/${{ matrix.platform.archive }}.json

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && endsWith(github.ref, '-native')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-native
        continue-on-error: true

      - name: Retry artifact download if failed
        if: failure()
        uses: actions/download-artifact@v4
        with:
          path: dist-native

      - name: Organize artifacts
        run: |
          # ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶åˆ° dist-native æ ¹ç›®å½•
          find dist-native -name "research-cli-*" -type f -exec mv {} dist-native/ \; || true
          # æ¸…ç†ç©ºç›®å½•
          find dist-native -type d -empty -delete || true
          # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
          ls -la dist-native/
          # ç¡®ä¿æˆ‘ä»¬æœ‰æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶
          echo "Checking for required files..."
          for file in research-cli-darwin-x64 research-cli-darwin-arm64 research-cli-win32-x64.exe research-cli-linux-x64 research-cli-linux-arm64; do
            if [ ! -f "dist-native/$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done

      - name: Create install script
        run: |
          cat > dist-native/install.sh << 'EOF'
          #!/bin/bash
          
          # Research CLI Native Wrapper - One-line Installer
          # Usage: curl -sSL https://github.com/iechor-research/research-cli/releases/download/v0.2.6-native/install.sh | bash
          
          set -e
          
          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color
          
          # Detect platform
          detect_platform() {
              local os=$(uname -s)
              local arch=$(uname -m)
              
              case "$os" in
                  Darwin)
                      case "$arch" in
                          x86_64) echo "research-cli-darwin-x64" ;;
                          arm64|aarch64) echo "research-cli-darwin-arm64" ;;
                          *) echo "unsupported" ;;
                      esac
                      ;;
                  Linux)
                      case "$arch" in
                          x86_64) echo "research-cli-linux-x64" ;;
                          aarch64|arm64) echo "research-cli-linux-arm64" ;;
                          *) echo "unsupported" ;;
                      esac
                      ;;
                  CYGWIN*|MINGW*|MSYS*)
                      case "$arch" in
                          x86_64) echo "research-cli-win32-x64.exe" ;;
                          *) echo "unsupported" ;;
                      esac
                      ;;
                  *)
                      echo "unsupported"
                      ;;
              esac
          }
          
          # Main installation function
          install_research_cli() {
              local platform=$(detect_platform)
              
              if [ "$platform" = "unsupported" ]; then
                  echo -e "${RED}âŒ Unsupported platform: $(uname -s) $(uname -m)${NC}"
                  echo "Supported platforms:"
                  echo "  - macOS (Intel & Apple Silicon)"
                  echo "  - Linux (x64 & ARM64)"
                  echo "  - Windows (x64)"
                  exit 1
              fi
              
              echo -e "${BLUE}ðŸš€ Installing Research CLI Native Wrapper...${NC}"
              echo -e "${YELLOW}ðŸ“¦ Platform: $platform${NC}"
              
              # Create installation directory
              local install_dir="$HOME/.local/bin"
              mkdir -p "$install_dir"
              
              # Download URL
              local version="v0.2.6-native"
              local download_url="https://github.com/iechor-research/research-cli/releases/download/$version/$platform"
              
              echo -e "${BLUE}ðŸ“¥ Downloading from: $download_url${NC}"
              
              # Download the binary
              if command -v curl >/dev/null 2>&1; then
                  curl -sSL "$download_url" -o "$install_dir/research-cli"
              elif command -v wget >/dev/null 2>&1; then
                  wget -q "$download_url" -O "$install_dir/research-cli"
              else
                  echo -e "${RED}âŒ Neither curl nor wget is available${NC}"
                  exit 1
              fi
              
              # Make executable
              chmod +x "$install_dir/research-cli"
              
              # Add to PATH if not already there
              local shell_config=""
              if [ -n "$BASH_VERSION" ]; then
                  shell_config="$HOME/.bashrc"
              elif [ -n "$ZSH_VERSION" ]; then
                  shell_config="$HOME/.zshrc"
              else
                  shell_config="$HOME/.profile"
              fi
              
              if [[ ":$PATH:" != *":$install_dir:"* ]]; then
                  echo "export PATH=\"$install_dir:\$PATH\"" >> "$shell_config"
                  echo -e "${YELLOW}ðŸ“ Added $install_dir to PATH in $shell_config${NC}"
                  echo -e "${YELLOW}ðŸ”„ Please restart your terminal or run: source $shell_config${NC}"
              fi
              
              echo -e "${GREEN}âœ… Installation completed successfully!${NC}"
              echo -e "${GREEN}ðŸŽ‰ You can now use: research-cli${NC}"
              echo ""
              echo -e "${BLUE}ðŸ“š Quick start:${NC}"
              echo "  research-cli --help"
              echo "  research-cli config show"
              echo "  research-cli models list"
              echo ""
              echo -e "${BLUE}ðŸŒŸ For more information, visit:${NC}"
              echo "  https://github.com/iechor-research/research-cli"
          }
          
          # Run installation
          install_research_cli
          EOF
          
          chmod +x dist-native/install.sh

      - name: Generate release notes
        run: |
          cat > dist-native/RELEASE_NOTES.md << 'EOF'
          # Research CLI Native Wrapper v0.2.6
          
          ðŸš€ **Cross-platform native wrapper for Research CLI**
          
          ## âœ¨ Features
          
          - **Ultra-lightweight**: ~500KB per binary (99% smaller than previous versions)
          - **Zero dependencies**: No Node.js runtime required
          - **Native performance**: Pure Rust wrapper with direct CLI execution
          - **Cross-platform**: Support for 5 major platforms
          - **One-line install**: Simple installation script
          
          ## ðŸ“¦ Supported Platforms
          
          | Platform | Architecture | File | Size |
          |----------|-------------|------|------|
          | macOS | Intel x64 | `research-cli-darwin-x64` | ~420KB |
          | macOS | Apple Silicon | `research-cli-darwin-arm64` | ~430KB |
          | Windows | x64 | `research-cli-win32-x64.exe` | ~500KB |
          | Linux | x64 | `research-cli-linux-x64` | ~450KB |
          | Linux | ARM64 | `research-cli-linux-arm64` | ~480KB |
          
          ## ðŸš€ Quick Install
          
          ```bash
          # One-line install (recommended)
          curl -sSL https://github.com/iechor-research/research-cli/releases/download/v0.2.6-native/install.sh | bash
          
          # Manual install
          # 1. Download the binary for your platform
          # 2. Make it executable: chmod +x research-cli-*
          # 3. Move to PATH: mv research-cli-* ~/.local/bin/research-cli
          ```
          
          ## ðŸŽ¯ Usage
          
          ```bash
          # Show help
          research-cli --help
          
          # Show configuration
          research-cli config show
          
          # List available models
          research-cli models list
          
          # Start research session
          research-cli
          ```
          
          ## ðŸ”§ Technical Details
          
          - **Runtime**: Pure Rust wrapper (no Node.js required)
          - **Execution**: Direct process spawning with inherited I/O
          - **Compatibility**: Full Research CLI feature support
          - **Performance**: Native speed with minimal overhead
          
          ## ðŸ“‹ Requirements
          
          - No runtime dependencies
          - Node.js installation (for Research CLI backend)
          - Compatible with all Research CLI features
          
          ## ðŸ› Troubleshooting
          
          If you encounter issues:
          
          1. **Permission denied**: Run `chmod +x research-cli-*`
          2. **Command not found**: Add binary to PATH or use full path
          3. **Node.js missing**: Install Node.js for Research CLI backend
          4. **Platform not supported**: Check supported platforms above
          
          ## ðŸ”— Links
          
          - **Repository**: https://github.com/iechor-research/research-cli
          - **Documentation**: https://github.com/iechor-research/research-cli/docs
          - **Issues**: https://github.com/iechor-research/research-cli/issues
          
          ---
          
          **Built with â¤ï¸ using GitHub Actions**
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Research CLI Native Wrapper ${{ github.ref_name }}
          body_path: dist-native/RELEASE_NOTES.md
          files: |
            dist-native/research-cli-*
            dist-native/install.sh
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Native wrapper built successfully for all platforms!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for file in dist-native/research-cli-*; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              name=$(basename "$file")
              echo "- **$name**: $size" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Installation:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'curl -sSL https://github.com/iechor-research/research-cli/releases/download/${{ github.ref_name }}/install.sh | bash' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Release URL**: https://github.com/iechor-research/research-cli/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY 